<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lectura diaria para MartÃ­n Bautista</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html{
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body{
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    .ios-scroll { -webkit-overflow-scrolling: touch; }
    .max-h-70dvh { max-height: 70dvh; }
    .max-h-520dvh { max-height: min(520px, 60dvh); }

    .kid-shadow { box-shadow: 0 10px 25px rgba(0,0,0,.10); }
    .btn-bounce:active { transform: translateY(1px) scale(.99); }
    button { touch-action: manipulation; }
    @media (min-width: 768px) { #textoHistoria { font-size: 1.35rem; line-height: 1.85; } }
    @media (min-width: 1024px){ #textoHistoria { font-size: 1.45rem; line-height: 1.90; } }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-sky-100 via-indigo-50 to-pink-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-4 md:p-8 space-y-4">

    <!-- Aviso si localStorage falla en Safari (file:// o modo privado) -->
    <div id="storageWarning" class="hidden kid-shadow rounded-3xl border border-amber-200 bg-amber-50 p-4">
      <div class="text-lg font-black">âš ï¸ Aviso de Safari</div>
      <div class="text-base font-semibold text-slate-700">
        Safari ha bloqueado el guardado local en este modo (suele pasar al abrir el archivo desde â€œArchivosâ€ o en modo privado).
        La app funcionarÃ¡, pero el diario podrÃ­a no guardarse hasta que se abra como â€œAÃ±adir a pantalla de inicioâ€ o fuera de modo privado.
      </div>
    </div>

    <!-- Aviso para iPhone Safari: AÃ±adir a pantalla de inicio -->
    <div id="iosInstallBox"
         class="hidden kid-shadow rounded-3xl border border-blue-200 bg-blue-50 p-4">
      <div class="text-xl font-black">ğŸ“² Mejor experiencia en iPhone</div>
      <p class="mt-1 text-base font-semibold text-slate-700">
        Para que el temporizador, los botones y el diario funcionen siempre bien en iPhone,
        aÃ±ade esta app a la pantalla de inicio.
      </p>

      <ol class="mt-2 list-decimal list-inside text-base font-semibold text-slate-700 space-y-1">
        <li>Pulsa el botÃ³n <strong>Compartir</strong> de Safari</li>
        <li>Elige <strong>â€œAÃ±adir a pantalla de inicioâ€</strong></li>
        <li>Abre la app desde el icono ğŸ“š</li>
      </ol>

      <div class="mt-3 rounded-2xl bg-white border border-blue-200 p-3 text-base font-semibold text-slate-700">
        ğŸ”µ En Safari: busca el icono de <strong>Compartir</strong> (cuadrado con flecha â†‘).
      </div>

      <button type="button" id="btnInstallHint"
        class="mt-3 btn-bounce rounded-2xl bg-blue-600 text-white px-5 py-3 font-extrabold text-xl">
        ğŸ“² AÃ±adir a pantalla de inicio
      </button>

      <p class="mt-2 text-sm font-bold text-slate-600">
        (Este botÃ³n no instala nada automÃ¡ticamente, solo te recuerda cÃ³mo hacerlo)
      </p>
    </div>

    <!-- HEADER -->
    <header class="kid-shadow rounded-3xl bg-white/80 backdrop-blur border border-white p-5 md:p-7">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div class="min-w-0">
          <h1 class="text-3xl md:text-4xl font-black tracking-tight break-words">
            ğŸ“š Lectura diaria para MartÃ­n Bautista
          </h1>
          <p class="text-lg md:text-xl font-semibold text-slate-700 break-words">
            ğŸ“… <span id="fechaHoy"></span>
            <span class="ml-2">â±ï¸ MÃ¡ximo: 15 minutos</span>
          </p>
        </div>

        <div class="flex flex-wrap gap-2 items-center">
          <div class="rounded-2xl bg-amber-50 border border-amber-200 px-4 py-2 font-bold text-amber-900">
            âœ… Hoy: <span id="estadoHoy">â€”</span>
          </div>
          <button type="button" id="btnVerDiario"
            class="btn-bounce rounded-2xl bg-slate-900 text-white px-4 py-2 font-extrabold text-lg hover:opacity-95">
            ğŸ“” Ver diario
          </button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="rounded-3xl bg-sky-50 border border-sky-200 p-4">
          <div class="text-lg font-black">ğŸ¯ Objetivo</div>
          <div class="text-2xl font-extrabold">Leer al menos 1 lectura hoy</div>
          <div class="text-sm font-semibold text-slate-700">Puedes generar infinitas lecturas al dÃ­a.</div>
        </div>

        <div class="rounded-3xl bg-indigo-50 border border-indigo-200 p-4">
          <div class="text-lg font-black">â±ï¸ Temporizador</div>
          <div class="text-2xl font-extrabold tabular-nums" id="timerDisplay">15:00</div>
          <div class="text-sm font-semibold text-slate-700">Se inicia al generar una lectura nueva.</div>
        </div>

        <div class="rounded-3xl bg-pink-50 border border-pink-200 p-4">
          <div class="text-lg font-black">ğŸŒŸ Tip</div>
          <div class="text-xl font-extrabold">Escribe frases completas</div>
          <div class="text-sm font-semibold text-slate-700">AsÃ­ mejoras vocabulario y ortografÃ­a âœï¸</div>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="grid grid-cols-1 lg:grid-cols-2 gap-4">

      <!-- LECTURA -->
      <section class="kid-shadow rounded-3xl bg-white/85 backdrop-blur border border-white p-5 md:p-7 space-y-4">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-2xl md:text-3xl font-black">ğŸ§¡ Lectura</h2>
          <button type="button" id="btnNuevaHistoria"
            class="btn-bounce rounded-2xl bg-emerald-600 text-white px-4 py-2 font-extrabold text-lg hover:bg-emerald-700">
            ğŸ² Nueva lectura
          </button>
        </div>

        <div class="rounded-3xl bg-gradient-to-r from-amber-50 to-emerald-50 border border-amber-200 p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div class="text-xl font-black break-words" id="tituloHistoria">â€”</div>
            <div class="text-sm font-bold text-slate-700">
              ğŸ”– Tema: <span id="temaHistoria">â€”</span>
              <span class="ml-2">â³ Estimado: <span id="tiempoEstimado">â€”</span></span>
              <span class="ml-2">â±ï¸ Llevas: <span id="tiempoTranscurrido" class="tabular-nums">00:00</span></span>
            </div>
          </div>
          <div class="mt-2 text-xs md:text-sm font-bold text-slate-600">
            (Estimado segÃºn velocidad media. El transcurrido es tu tiempo real.)
          </div>
        </div>

        <!-- BOTONES ANTES DE LA HISTORIA -->
        <div class="rounded-3xl bg-white border border-slate-200 p-4 space-y-3">
          <div class="flex flex-wrap gap-2 items-center">
            <button type="button" id="btnIniciar"
              class="btn-bounce rounded-2xl bg-indigo-700 text-white px-5 py-3 font-extrabold text-xl hover:bg-indigo-800">
              â–¶ï¸ Iniciar (15:00)
            </button>
            <button type="button" id="btnPausar"
              class="btn-bounce hidden rounded-2xl bg-slate-200 text-slate-900 px-5 py-3 font-extrabold text-xl hover:bg-slate-300">
              â¸ï¸ Pausar
            </button>
            <button type="button" id="btnReiniciar"
              class="btn-bounce rounded-2xl bg-white border border-slate-300 text-slate-900 px-5 py-3 font-extrabold text-xl hover:bg-slate-50">
              ğŸ”„ Reiniciar
            </button>
            <span id="timerMsg" class="text-lg font-bold text-slate-700"></span>
          </div>
        </div>

        <!-- HISTORIA -->
        <article id="textoHistoria"
          class="rounded-3xl bg-white border border-slate-200 p-4 md:p-5 text-lg md:text-xl leading-relaxed font-semibold text-slate-800 whitespace-pre-wrap break-words">
          Pulsa â€œğŸ² Nueva lecturaâ€ para comenzar.
        </article>

        <div class="rounded-3xl bg-white border border-slate-200 p-4">
          <div class="text-lg md:text-xl font-black">ğŸ“Š ComparaciÃ³n de tiempo</div>
          <div class="mt-2 text-lg md:text-xl font-semibold text-slate-800">
            â³ Estimado: <span class="font-black" id="tiempoEstimado2">â€”</span>
            <span class="mx-2">â€¢</span>
            â±ï¸ Transcurrido: <span class="font-black tabular-nums" id="tiempoTranscurrido2">00:00</span>
          </div>
        </div>

        <div id="glosarioBox" class="hidden rounded-3xl bg-slate-50 border border-slate-200 p-4">
          <div class="text-xl md:text-2xl font-black">ğŸ“š Mini glosario</div>
          <p class="text-base md:text-lg font-semibold text-slate-700 mt-1">
            Palabras elegidas al azar desde la lectura (definiciÃ³n offline).
          </p>
          <ul id="glosarioLista" class="mt-3 space-y-2 text-lg md:text-xl font-semibold"></ul>
        </div>

        <div class="rounded-3xl bg-indigo-50 border border-indigo-200 p-4 space-y-3">
          <h3 class="text-xl md:text-2xl font-black">ğŸ§  Â¿CuÃ¡l crees que es la moraleja?</h3>
          <p class="text-base md:text-lg font-semibold text-slate-700">
            Escribe tu idea con buenas frases. Luego compara con la moraleja real.
          </p>

          <textarea id="inputMoralejaNino"
            class="w-full rounded-2xl border border-indigo-200 bg-white p-3 md:p-4 text-lg md:text-xl font-semibold focus:outline-none focus:ring-4 focus:ring-indigo-200"
            rows="4" placeholder="âœï¸ Escribe aquÃ­ tu moraleja..."></textarea>

          <div class="flex flex-wrap gap-2 items-center">
            <button type="button" id="btnGuardarYVer"
              class="btn-bounce rounded-2xl bg-amber-500 text-white px-5 py-3 font-extrabold text-xl hover:bg-amber-600">
              ğŸ’¾ Guardar y ver â€œMoralejaâ€
            </button>

            <button type="button" id="btnMoraleja"
              class="btn-bounce hidden rounded-2xl bg-rose-600 text-white px-5 py-3 font-extrabold text-xl hover:bg-rose-700">
              ğŸ“Œ Moraleja
            </button>

            <span id="saveMsg" class="text-base md:text-lg font-bold text-slate-700"></span>
          </div>

          <div id="moralejaBox" class="hidden rounded-3xl bg-white border border-rose-200 p-4">
            <div class="text-xl md:text-2xl font-black">ğŸ“Œ Moraleja real</div>
            <p class="mt-2 text-lg md:text-xl font-semibold text-slate-800 break-words" id="textoMoralejaReal"></p>
          </div>
        </div>
      </section>

      <!-- DIARIO -->
      <section class="kid-shadow rounded-3xl bg-white/85 backdrop-blur border border-white p-5 md:p-7 space-y-4">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-2xl md:text-3xl font-black">ğŸ“” Diario</h2>
          <button type="button" id="btnExportar"
            class="btn-bounce rounded-2xl bg-slate-900 text-white px-4 py-2 font-extrabold text-lg hover:opacity-95">
            â¬‡ï¸ Exportar (TXT)
          </button>
        </div>

        <div class="rounded-3xl bg-slate-50 border border-slate-200 p-4">
          <div class="text-lg font-black">ğŸ—“ï¸ Resumen rÃ¡pido</div>
          <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="rounded-2xl bg-white border border-slate-200 p-3">
              <div class="font-black text-lg">âœ… Lecturas hoy</div>
              <div class="text-2xl font-extrabold" id="lecturasHoyCount">0</div>
            </div>
            <div class="rounded-2xl bg-white border border-slate-200 p-3">
              <div class="font-black text-lg">ğŸ“š Lecturas totales</div>
              <div class="text-2xl font-extrabold" id="lecturasTotalCount">0</div>
            </div>
            <div class="rounded-2xl bg-white border border-slate-200 p-3">
              <div class="font-black text-lg">ğŸ“ â€œFallosâ€ anotados</div>
              <div class="text-2xl font-extrabold" id="fallosCount">0</div>
            </div>
          </div>
        </div>

        <div class="rounded-3xl bg-white border border-slate-200 overflow-hidden">
          <div class="bg-slate-900 text-white px-4 py-3 font-black text-lg">
            ğŸ“– Ãšltimas entradas (fecha y hora)
          </div>
          <div id="listaEntradas" class="p-4 space-y-3 ios-scroll max-h-520dvh overflow-auto">
            <p class="text-lg font-semibold text-slate-700">AÃºn no hay entradas guardadas.</p>
          </div>
        </div>

        <button type="button" id="btnBorrarTodo"
          class="btn-bounce w-full rounded-2xl bg-white border border-rose-300 text-rose-700 px-5 py-3 font-extrabold text-xl hover:bg-rose-50">
          ğŸ§¹ Borrar TODO (LocalStorage)
        </button>

        <p class="text-sm font-semibold text-slate-600">
          ğŸ” Todo se guarda solo en este dispositivo (LocalStorage del navegador).
        </p>
      </section>
    </main>
  </div>

  <!-- Modal diario -->
  <div id="modalDiario" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative max-w-3xl mx-auto mt-10 md:mt-16 p-4">
      <div class="kid-shadow rounded-3xl bg-white border border-white p-5 md:p-7 space-y-3">
        <div class="flex items-center justify-between gap-3">
          <div class="text-2xl md:text-3xl font-black">ğŸ“” Diario completo</div>
          <button type="button" id="btnCerrarDiario"
            class="btn-bounce rounded-2xl bg-slate-900 text-white px-4 py-2 font-extrabold text-lg hover:opacity-95">
            âœ–ï¸ Cerrar
          </button>
        </div>
        <div class="rounded-3xl border border-slate-200 overflow-hidden">
          <div class="bg-slate-900 text-white px-4 py-3 font-black text-lg">
            ğŸ•’ Entradas guardadas
          </div>
          <div id="listaEntradasModal" class="p-4 space-y-3 ios-scroll max-h-70dvh overflow-auto"></div>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function(){

  /* ========= Safe Storage (iOS Safari file:// / modo privado) ========= */
  var memoryStore = {};
  function storageAvailable(){
    try{
      var x = "__test__" + Date.now();
      window.localStorage.setItem(x, x);
      window.localStorage.removeItem(x);
      return true;
    }catch(e){
      return false;
    }
  }
  var hasLS = storageAvailable();
  var SafeStorage = {
    getItem: function(k){
      try{ if(hasLS) return window.localStorage.getItem(k); }catch(e){}
      return memoryStore.hasOwnProperty(k) ? memoryStore[k] : null;
    },
    setItem: function(k,v){
      try{ if(hasLS) { window.localStorage.setItem(k, v); return; } }catch(e){}
      memoryStore[k] = v;
    },
    removeItem: function(k){
      try{ if(hasLS) { window.localStorage.removeItem(k); return; } }catch(e){}
      delete memoryStore[k];
    }
  };

  var storageWarning = document.getElementById("storageWarning");
  if(!hasLS && storageWarning) storageWarning.classList.remove("hidden");

  /* ========= DetecciÃ³n iOS Safari y aviso de instalaciÃ³n ========= */
  (function(){
    var ua = window.navigator.userAgent;
    var isIOS = /iPad|iPhone|iPod/.test(ua);
    var isSafari = /^((?!chrome|android).)*safari/i.test(ua);
    var isStandalone = window.navigator.standalone === true;

    var iosBox = document.getElementById("iosInstallBox");
    if(isIOS && isSafari && !isStandalone && iosBox){
      iosBox.classList.remove("hidden");
    }

    var btnInstallHint = document.getElementById("btnInstallHint");
    if(btnInstallHint){
      btnInstallHint.addEventListener("click", function(){
        alert("En Safari:\n\n1) Pulsa el botÃ³n Compartir (â¬†ï¸)\n2) Elige â€œAÃ±adir a pantalla de inicioâ€\n3) Abre desde el icono ğŸ“š");
      });
    }
  })();

  /* ========= Utilidades ========= */
  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoDate(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
  function prettyDateES(d){ return d.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}); }
  function nowISO(){
    var d = new Date();
    return isoDate(d)+" "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
  }
  function todayKey(){ return isoDate(new Date()); }
  function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
  function escapeHtml(s){
    s = String(s == null ? "" : s);
    return s
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function wordCount(text){
    return String(text || "").trim().split(/\s+/).filter(Boolean).length;
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function fmtTimer(secs){
    var m = Math.floor(secs/60);
    var s = secs%60;
    return pad2(m)+":"+pad2(s);
  }
  function fnv1a(str){
    var h = 0x811c9dc5;
    for (var i=0; i<str.length; i++){
      h ^= str.charCodeAt(i);
      h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
    }
    return ("00000000" + h.toString(16)).slice(-8);
  }

  /* ========= Local â€œDBâ€ ========= */
  var LS_KEY = "lectura_diaria_martin_bautista_v4";
  var defaultData = { entries: [], misses: [], usedStoryHashes: [] };

  function loadData(){
    try{
      var raw = SafeStorage.getItem(LS_KEY);
      if(!raw) return JSON.parse(JSON.stringify(defaultData));
      var p = JSON.parse(raw);
      return {
        entries: Array.isArray(p.entries) ? p.entries : [],
        misses: Array.isArray(p.misses) ? p.misses : [],
        usedStoryHashes: Array.isArray(p.usedStoryHashes) ? p.usedStoryHashes : []
      };
    }catch(e){
      return JSON.parse(JSON.stringify(defaultData));
    }
  }
  function saveData(data){
    SafeStorage.setItem(LS_KEY, JSON.stringify(data));
  }

  var data = loadData();

  /* ========= Diccionario (offline) ========= */
  var DICT = {
    "abandonar":"Dejar algo o a alguien.",
    "abundante":"Que existe en gran cantidad.",
    "acatar":"Obedecer una norma o decisiÃ³n.",
    "aclarar":"Explicar para que se entienda mejor.",
    "acogedor":"Que hace sentir comodidad y seguridad.",
    "actitud":"Forma de comportarse o reaccionar.",
    "adaptarse":"Cambiar para ajustarse a una situaciÃ³n.",
    "adversidad":"SituaciÃ³n difÃ­cil o problema.",
    "afecto":"CariÃ±o que se siente por alguien.",
    "afinar":"Mejorar algo con cuidado y detalle.",
    "agotamiento":"Cansancio muy fuerte.",
    "alegorÃ­a":"Historia que enseÃ±a con sÃ­mbolos.",
    "alternativa":"Otra opciÃ³n posible.",
    "analizar":"Estudiar algo con atenciÃ³n.",
    "anticipar":"Pensar en algo antes de que pase.",
    "apaciguar":"Calmar una situaciÃ³n tensa.",
    "apreciar":"Valorar la importancia de algo.",
    "argumento":"RazÃ³n que apoya una idea.",
    "armonÃ­a":"Buena relaciÃ³n y equilibrio.",
    "asombro":"Sorpresa grande.",
    "asumir":"Aceptar una responsabilidad.",
    "atenciÃ³n":"Capacidad de concentrarse.",
    "audaz":"Valiente para actuar.",
    "autonomÃ­a":"Capacidad de actuar solo.",
    "beneficio":"Resultado positivo o ventaja.",
    "borrador":"Primera versiÃ³n de un texto.",
    "cauteloso":"Que actÃºa con cuidado.",
    "celebrar":"Reconocer algo con alegrÃ­a.",
    "claridad":"Facilidad para entender algo.",
    "colaborar":"Trabajar con otros para un fin.",
    "complejidad":"Dificultad por tener muchas partes.",
    "comprender":"Entender bien una idea.",
    "concentraciÃ³n":"AtenciÃ³n mantenida en algo.",
    "consecuencia":"Resultado de una acciÃ³n.",
    "constancia":"Continuar sin abandonar.",
    "construir":"Crear algo poco a poco.",
    "contundente":"Muy claro, difÃ­cil de negar.",
    "contraste":"Diferencia clara entre dos cosas.",
    "convicciÃ³n":"Creencia firme.",
    "cordial":"Amable y respetuoso.",
    "criterio":"Capacidad de decidir bien.",
    "cuestionar":"Preguntar para comprender o comprobar.",
    "decisiÃ³n":"ElecciÃ³n tomada.",
    "deducir":"Sacar una conclusiÃ³n con pistas.",
    "deliberar":"Pensar antes de decidir.",
    "demostrar":"Probar algo con hechos.",
    "desafÃ­o":"Reto difÃ­cil.",
    "desarrollar":"Hacer crecer una habilidad.",
    "describir":"Explicar cÃ³mo es algo.",
    "desenlace":"Final de una historia.",
    "desigual":"Que no es equitativo o parejo.",
    "destacar":"Sobresalir o llamar la atenciÃ³n.",
    "detallado":"Con muchos detalles.",
    "determinaciÃ³n":"DecisiÃ³n firme de lograr algo.",
    "diligente":"Que trabaja con cuidado y constancia.",
    "disciplina":"Capacidad de seguir reglas o un plan.",
    "discernir":"Distinguir diferencias con atenciÃ³n.",
    "discreto":"Que actÃºa con prudencia, sin llamar atenciÃ³n.",
    "disposiciÃ³n":"Actitud para hacer algo.",
    "diversidad":"Variedad de cosas o ideas.",
    "elocuente":"Que se expresa con claridad y fuerza.",
    "empatÃ­a":"Ponerse en el lugar del otro.",
    "enfocar":"Dirigir la atenciÃ³n hacia algo.",
    "entusiasmo":"Ganas y energÃ­a por hacer algo.",
    "equilibrio":"Estado estable entre partes.",
    "esencial":"Lo mÃ¡s importante.",
    "esfuerzo":"EnergÃ­a usada para lograr algo.",
    "estrategia":"Plan para conseguir un objetivo.",
    "evidencia":"Prueba que apoya una idea.",
    "exigir":"Pedir con firmeza.",
    "explicar":"Hacer comprensible algo.",
    "extraordinario":"Fuera de lo comÃºn.",
    "fascinante":"Muy interesante.",
    "fortalecer":"Hacer mÃ¡s fuerte.",
    "frustraciÃ³n":"Molestia por no lograr algo.",
    "fundamento":"Base que sostiene una idea.",
    "generosidad":"Deseo de ayudar y compartir.",
    "habilidad":"Capacidad para hacer algo bien.",
    "honestidad":"Decir la verdad y actuar con transparencia.",
    "hipÃ³tesis":"Idea que se prueba para ver si es cierta.",
    "imparcial":"Que no toma partido.",
    "impulsivo":"Que actÃºa sin pensar mucho.",
    "inquietud":"PreocupaciÃ³n o nervios.",
    "Ã­ntegro":"Honesto y correcto.",
    "interpretar":"Entender el significado de algo.",
    "investigar":"Buscar informaciÃ³n para entender mejor.",
    "justicia":"Actuar de forma correcta y equitativa.",
    "lealtad":"Fidelidad y compromiso.",
    "matizar":"Explicar con mÃ¡s detalle o precisiÃ³n.",
    "meticuloso":"Muy cuidadoso con los detalles.",
    "moderaciÃ³n":"Evitar excesos.",
    "motivar":"Dar ganas o razones para actuar.",
    "objetivo":"Meta que se quiere alcanzar.",
    "observar":"Mirar con atenciÃ³n para notar detalles.",
    "optimista":"Que espera resultados buenos.",
    "organizar":"Ordenar ideas o cosas.",
    "paciencia":"Capacidad de esperar sin enfadarse.",
    "perspicaz":"Que entiende rÃ¡pido.",
    "persistir":"Seguir intentando, no rendirse.",
    "plantear":"Proponer una idea o problema.",
    "precauciÃ³n":"Cuidado para evitar daÃ±os.",
    "preciso":"Exacto, sin error.",
    "prioridad":"Lo mÃ¡s importante primero.",
    "prudente":"Que piensa antes de actuar.",
    "reflexiÃ³n":"Pensar con calma para comprender mejor.",
    "reconciliarse":"Volver a estar bien tras un problema.",
    "reconocer":"Admitir un error o notar algo importante.",
    "resiliencia":"Capacidad de recuperarse tras dificultades.",
    "responsabilidad":"Cumplir deberes y aceptar consecuencias.",
    "sereno":"Tranquilo y calmado.",
    "solidaridad":"Ayudar a otros cuando lo necesitan.",
    "sugerencia":"Idea propuesta para ayudar.",
    "tenaz":"Que no se rinde.",
    "tolerancia":"Respeto a diferencias.",
    "valentÃ­a":"Actuar aunque haya miedo.",
    "verificar":"Comprobar si algo es cierto."
  };

  function fallbackDefinition(){
    return "Palabra interesante. Intenta usarla en una frase y deduce su sentido por el contexto.";
  }

  /* ========= Glosario desde el texto ========= */
  var STOPWORDS = new Set([
    "a","al","algo","algunas","algunos","allÃ­","ante","antes","aquÃ­","asÃ­","aunque","bajo","bien","cada","casi","como","con",
    "contra","cual","cuando","de","del","desde","donde","dos","el","ella","ellas","ellos","en","entre","era","ese","eso","esta","estaba",
    "este","esto","fue","ha","hace","hacia","han","hasta","hay","la","las","le","les","lo","los","mÃ¡s","me","mi","mientras",
    "muy","ni","no","nos","o","para","pero","por","porque","que","se","ser","sin","sobre","su","sus","tambiÃ©n","tan","te","tenÃ­a","tiene",
    "todo","todos","tu","un","una","uno","unos","y","ya"
  ]);

  function normalizeWord(w){
    return String(w || "")
      .toLowerCase()
      .replace(/[â€œâ€"']/g,"")
      .replace(/[.,;:!?Â¿Â¡(){}\[\]<>]/g,"")
      .replace(/^[^a-zÃ¡Ã©Ã­Ã³ÃºÃ±Ã¼]+|[^a-zÃ¡Ã©Ã­Ã³ÃºÃ±Ã¼]+$/g,"")
      .trim();
  }
  function extractCandidateWords(story){
    var tokens = String(story||"").split(/\s+/).map(normalizeWord).filter(Boolean);
    var uniq = new Set();
    for(var i=0;i<tokens.length;i++){
      var t = tokens[i];
      if(t.length < 7) continue;
      if(STOPWORDS.has(t)) continue;
      if(/^\d+$/.test(t)) continue;
      uniq.add(t);
    }
    return Array.from(uniq);
  }
  function pickRandomUnique(arr, n){
    var copy = arr.slice();
    for (var i = copy.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = copy[i]; copy[i] = copy[j]; copy[j] = tmp;
    }
    return copy.slice(0, Math.min(n, copy.length));
  }
  function buildGlossaryFromStory(story, count){
    if(count == null) count = 5;
    var candidates = extractCandidateWords(story);
    var chosen = pickRandomUnique(candidates, 14);
    var withDefs = [];
    for(var i=0;i<chosen.length;i++){
      var w = chosen[i];
      var def = DICT[w] || fallbackDefinition(w);
      withDefs.push({ w:w, d:def });
      if(withDefs.length >= count) break;
    }
    return withDefs;
  }

  /* ========= Generador (10â€“15 min) ========= */
  var themes = [
    { theme: "Amistad ğŸ¤", moral: "La amistad crece cuando escuchas, compartes y cuidas a los demÃ¡s." },
    { theme: "Esfuerzo ğŸ’ª", moral: "Con prÃ¡ctica y paciencia, lo que hoy cuesta maÃ±ana se vuelve posible." },
    { theme: "Honestidad ğŸ§¼", moral: "Decir la verdad construye confianza y te hace mÃ¡s fuerte por dentro." },
    { theme: "Respeto ğŸ«¶", moral: "Respetar a otros y a ti mismo hace que todos se sientan seguros y valiosos." },
    { theme: "ValentÃ­a ğŸ¦", moral: "Ser valiente no es no tener miedo, es actuar con cuidado aunque exista miedo." },
    { theme: "Gratitud ğŸ™", moral: "Agradecer lo bueno te ayuda a ver lo que sÃ­ tienes y a ser mÃ¡s feliz." },
    { theme: "Responsabilidad ğŸ’", moral: "Cumplir tus deberes te da libertad y confianza en ti mismo." },
    { theme: "Bondad ğŸŒˆ", moral: "Un acto pequeÃ±o de bondad puede mejorar el dÃ­a de alguien muchÃ­simo." }
  ];
  var characters = ["MartÃ­n ğŸ§’","Luna ğŸ¶","Rayo ğŸ±","TomÃ¡s ğŸ§‘â€ğŸ¤â€ğŸ§‘","Sofi ğŸ‘§","Nico ğŸ§‘","La abuela Ana ğŸ‘µ","El profe Leo ğŸ‘¨â€ğŸ«"];
  var places = ["en un parque con columpios ğŸŒ³","en la biblioteca ğŸ“š","en el patio del colegio ğŸ«","en la playa ğŸ–ï¸","en un barrio colorido ğŸ˜ï¸","en una montaÃ±a ğŸ”ï¸","en un museo ğŸ›ï¸","en una tienda de juguetes ğŸ§¸"];
  var objects = ["una brÃºjula antigua ğŸ§­","un cuaderno encuadernado ğŸ““","una llave diminuta ğŸ”‘","una caja de acuarelas ğŸ¨","un balÃ³n gastado âš½","un reloj de arena â³","un mapa arrugado ğŸ—ºï¸","una mochila resistente ğŸ’"];
  var problems = [
    "alguien se sintiÃ³ excluido ğŸ˜”","perdieron algo importante ğŸ˜Ÿ","hubo un malentendido ğŸ¤”","tenÃ­an miedo de intentarlo ğŸ˜¬",
    "se enojaron por una tonterÃ­a ğŸ˜¤","querÃ­an rendirse demasiado pronto ğŸ«£","tenÃ­an que elegir entre lo fÃ¡cil y lo correcto âš–ï¸",
    "nadie querÃ­a pedir perdÃ³n primero ğŸ™ˆ"
  ];
  var resolutions = [
    "hablaron con calma y escucharon de verdad ğŸ‘‚","pidieron ayuda a tiempo y trabajaron en equipo ğŸ§©","hicieron un plan paso a paso y lo siguieron âœ…",
    "dijeron la verdad aunque daba vergÃ¼enza ğŸ§¼","compartieron y se turnaron con paciencia ğŸ”","pidieron perdÃ³n y se abrazaron ğŸ¤—",
    "ayudaron a quien lo necesitaba sin esperar nada ğŸŒŸ","practicaron un poquito cada dÃ­a hasta lograrlo ğŸ“ˆ"
  ];
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  var READING_WPM = 130;
  var MIN_MINUTES = 10;
  var MAX_MINUTES = 15;
  var beats = ["planteamiento","incidente","bÃºsqueda","duda","aprendizaje","decisiÃ³n","clÃ­max","cierre"];

  function buildStoryText(){
    var t = pick(themes);
    var c1 = pick(characters);
    var c2 = pick(characters);
    if(c2 === c1) c2 = pick(characters);

    var place = pick(places);
    var obj = pick(objects);
    var prob = pick(problems);
    var res = pick(resolutions);

    var title = "âœ¨ " + c1 + " y " + obj;
    var theme = t.theme;

    var minWords = Math.round(READING_WPM * MIN_MINUTES);
    var maxWords = Math.round(READING_WPM * MAX_MINUTES);
    var targetWords = Math.floor(minWords + Math.random() * (maxWords - minWords + 1));

    var intro = [
      c1 + " estaba " + place + ". La tarde tenÃ­a un aire especial: no por algo mÃ¡gico, sino por esa sensaciÃ³n sutil de que cualquier detalle puede volverse importante si uno observa con atenciÃ³n.",
      "Cerca de un banco, apareciÃ³ " + obj + ". No brillaba como en los cuentos, pero parecÃ­a haber viajado por manos distintas; esa idea despertÃ³ curiosidad y, al mismo tiempo, prudencia.",
      "A los pocos minutos llegÃ³ " + c2 + ". â€œNo sÃ© por quÃ©, pero siento que esto nos estÃ¡ invitando a pensarâ€, dijo en voz baja, como si temiera romper el silencio con una palabra demasiado fuerte."
    ];

    function buildParagraph(beat){
      var v = {
        planteamiento:[
          "Decidieron no precipitarse. En lugar de actuar por impulso, se sentaron a organizar ideas y a describir con calma lo que cada uno veÃ­a y sentÃ­a, sin burlas ni interrupciones.",
          "Hablaron de lo que les habÃ­a pasado en el colegio: a veces una frase mal dicha crea un desacuerdo; en cambio, una explicaciÃ³n clara puede evitar una consecuencia incÃ³moda."
        ],
        incidente:[
          "Entonces apareciÃ³ el problema: " + prob + ". No fue un desastre enorme, pero sÃ­ suficiente para tensar el Ã¡nimo y poner a prueba su paciencia.",
          c2 + " apretÃ³ los labios. â€œEsto va a acabar malâ€, murmurÃ³. " + c1 + " notÃ³ inquietud: esa mezcla de prisa y nervios que empuja a resolverlo todo sin pensar."
        ],
        bÃºsqueda:[
          "En vez de discutir, hicieron algo inteligente: buscaron argumentos y contraargumentos. â€œYo digo mi idea y tÃº la matizasâ€, propuso " + c1 + ". SonÃ³ serio, pero ayudÃ³.",
          "Separaron lo urgente de lo importante. A veces la soluciÃ³n no es rÃ¡pida; es una resoluciÃ³n construida paso a paso, con constancia y disciplina."
        ],
        duda:[
          "La duda llegÃ³ como una nube pequeÃ±a. â€œÂ¿Y si nos equivocamos?â€, preguntÃ³ " + c2 + ". " + c1 + " respirÃ³: equivocarse tambiÃ©n enseÃ±a si uno revisa lo que hizo y aprende.",
          "Tuvieron que hablar con respeto incluso cuando estaban molestos. La voz podÃ­a ser puenteâ€¦ o pared. Eligieron el puente."
        ],
        aprendizaje:[
          c1 + " comprendiÃ³ algo: la responsabilidad se demuestra con detalles. Esperar turno. Reconocer errores. Escuchar hasta el final sin interrumpir.",
          c2 + " se volviÃ³ mÃ¡s sereno. No porque el problema desapareciera, sino porque aprendiÃ³ a mirarlo con calma, como si el tiempo se estirara para darles espacio."
        ],
        decisiÃ³n:[
          "LlegÃ³ la decisiÃ³n difÃ­cil: escoger lo correcto aunque no fuera lo mÃ¡s cÃ³modo. â€œHagÃ¡moslo bien, aunque cuesteâ€, dijo " + c1 + " con determinaciÃ³n.",
          "Usaron " + obj + " como sÃ­mbolo. Cada vez que se impacientaban, lo miraban y recordaban el plan. ParecÃ­a una tonterÃ­aâ€¦ hasta que empezÃ³ a funcionar."
        ],
        clÃ­max:[
          "La situaciÃ³n se tensÃ³. Hubo un instante en el que cualquier palabra podÃ­a encender una peleaâ€¦ o abrir una puerta.",
          "Entonces, " + res + ". No fue perfecto, pero fue real. Y lo real enseÃ±a: uno tropieza, respira, corrige y vuelve a intentar."
        ],
        cierre:[
          "El ambiente cambiÃ³, como cuando una habitaciÃ³n se ventila y todo se vuelve mÃ¡s ligero. " + c2 + " sonriÃ³: â€œCreo que nos entendimos de verdadâ€.",
          c1 + " guardÃ³ una idea final: mejorar no es un gesto heroico; es una costumbre. Y las costumbres, como la lectura, se construyen un dÃ­a a la vez."
        ]
      };
      var arr = v[beat] || v.planteamiento;
      var p1 = pick(arr), p2 = pick(arr);
      var p3 = (Math.random() < 0.45) ? pick(arr) : "";
      return [p1,p2,p3].filter(Boolean).join(" ");
    }

    var paragraphs = [];
    paragraphs = paragraphs.concat(intro);
    paragraphs.push("");

    while(wordCount(paragraphs.join("\n\n")) < targetWords){
      var b = pick(beats);
      paragraphs.push(buildParagraph(b));
      if(Math.random() < 0.40){
        paragraphs.push("â€”" + c2 + ": â€œÂ¿Y si probamos otra manera, sin gritar?â€\nâ€”" + c1 + ": â€œSÃ­. Si nos equivocamos, lo corregimos. Eso tambiÃ©n es aprender.â€");
      }
      paragraphs.push("");
      if(wordCount(paragraphs.join("\n\n")) > targetWords + 180) break;
    }

    paragraphs.push("Al despedirse, " + c1 + " sintiÃ³ un orgullo sereno: no por â€œganarâ€, sino por haberse comportado con respeto y cabeza frÃ­a. Esa noche pensÃ³ que leer y pensar se parecen: ambos te enseÃ±an a elegir mejor tus palabras. ğŸ“šâœ¨");

    var story = paragraphs.join("\n\n").trim();
    var estimatedMinutes = clamp(Math.round(wordCount(story) / READING_WPM), MIN_MINUTES, MAX_MINUTES);
    return { title:title, theme:theme, story:story, realMoral:t.moral, estimatedMinutes:estimatedMinutes };
  }

  function generateUniqueReading(){
    var used = new Set(data.usedStoryHashes);
    for(var i=0;i<80;i++){
      var base = buildStoryText();
      var realHash = fnv1a(base.story);
      if(used.has(realHash)) continue;

      var glossary = buildGlossaryFromStory(base.story, 5);
      data.usedStoryHashes.push(realHash);
      saveData(data);

      base.glossary = glossary;
      base.storyHash = realHash;
      base.generatedAt = nowISO();
      return base;
    }
    var b2 = buildStoryText();
    b2.story = b2.story + "\n\n(Nota: Lectura Ãºnica #" + uid().slice(0,6) + ")";
    b2.storyHash = fnv1a(b2.story);
    b2.glossary = buildGlossaryFromStory(b2.story, 5);
    data.usedStoryHashes.push(b2.storyHash);
    saveData(data);
    b2.generatedAt = nowISO();
    return b2;
  }

  /* ========= DOM ========= */
  var elFechaHoy = document.getElementById("fechaHoy");
  var elEstadoHoy = document.getElementById("estadoHoy");
  var elTimerDisplay = document.getElementById("timerDisplay");
  var elTituloHistoria = document.getElementById("tituloHistoria");
  var elTemaHistoria = document.getElementById("temaHistoria");
  var elTextoHistoria = document.getElementById("textoHistoria");
  var elTiempoEstimado = document.getElementById("tiempoEstimado");
  var elTiempoEstimado2 = document.getElementById("tiempoEstimado2");
  var elTiempoTranscurrido = document.getElementById("tiempoTranscurrido");
  var elTiempoTranscurrido2 = document.getElementById("tiempoTranscurrido2");

  var glosarioBox = document.getElementById("glosarioBox");
  var glosarioLista = document.getElementById("glosarioLista");

  var btnNuevaHistoria = document.getElementById("btnNuevaHistoria");
  var btnIniciar = document.getElementById("btnIniciar");
  var btnPausar = document.getElementById("btnPausar");
  var btnReiniciar = document.getElementById("btnReiniciar");
  var elTimerMsg = document.getElementById("timerMsg");

  var inputMoralejaNino = document.getElementById("inputMoralejaNino");
  var btnGuardarYVer = document.getElementById("btnGuardarYVer");
  var btnMoraleja = document.getElementById("btnMoraleja");
  var moralejaBox = document.getElementById("moralejaBox");
  var elMoralejaReal = document.getElementById("textoMoralejaReal");
  var elSaveMsg = document.getElementById("saveMsg");

  var lecturasHoyCount = document.getElementById("lecturasHoyCount");
  var lecturasTotalCount = document.getElementById("lecturasTotalCount");
  var fallosCount = document.getElementById("fallosCount");
  var listaEntradas = document.getElementById("listaEntradas");

  var btnExportar = document.getElementById("btnExportar");
  var btnBorrarTodo = document.getElementById("btnBorrarTodo");

  var btnVerDiario = document.getElementById("btnVerDiario");
  var modalDiario = document.getElementById("modalDiario");
  var btnCerrarDiario = document.getElementById("btnCerrarDiario");
  var listaEntradasModal = document.getElementById("listaEntradasModal");

  var currentStory = {
    title:"â€”", theme:"â€”",
    story:"Pulsa â€œğŸ² Nueva lecturaâ€ para comenzar.",
    realMoral:"",
    estimatedMinutes:null,
    glossary:[],
    storyHash:"",
    generatedAt:""
  };

  /* ========= Timer ========= */
  var timerSeconds = 15*60;
  var timerRunning = false;
  var timerInterval = null;
  var elapsedSeconds = 0;

  function updateElapsedUI(){
    var txt = fmtTimer(elapsedSeconds);
    elTiempoTranscurrido.textContent = txt;
    elTiempoTranscurrido2.textContent = txt;
  }
  function stopTimer(){
    timerRunning = false;
    if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
  }
  function resetTimer(){
    stopTimer();
    timerSeconds = 15*60;
    elTimerDisplay.textContent = fmtTimer(timerSeconds);
    elTimerMsg.textContent = "";
    btnIniciar.classList.remove("hidden");
    btnPausar.classList.add("hidden");
    elapsedSeconds = 0;
    updateElapsedUI();
  }
  function startTimer(){
    if(timerRunning) return;
    timerRunning = true;
    btnIniciar.classList.add("hidden");
    btnPausar.classList.remove("hidden");
    elTimerMsg.textContent = "â³ Â¡A leer! TÃº puedes ğŸ˜„";

    timerInterval = setInterval(function(){
      timerSeconds = Math.max(0, timerSeconds-1);
      elapsedSeconds += 1;
      updateElapsedUI();
      elTimerDisplay.textContent = fmtTimer(timerSeconds);

      if(timerSeconds<=0){
        stopTimer();
        btnPausar.classList.add("hidden");
        btnIniciar.classList.remove("hidden");
        elTimerMsg.textContent = "â° Â¡Se acabÃ³ el tiempo! Puedes guardar tu moraleja ğŸ˜Š";
      }
    }, 1000);
  }

  /* ========= UI ========= */
  function todaysEntries(){
    var td = todayKey();
    return data.entries.filter(function(e){ return e.date === td; });
  }
  function setTodayStatus(){
    var count = todaysEntries().length;
    elEstadoHoy.textContent = (count > 0) ? ("SÃ­ ("+count+") ğŸ‰") : "No ğŸ˜´";
  }
  function renderCounts(){
    lecturasHoyCount.textContent = String(todaysEntries().length);
    lecturasTotalCount.textContent = String(data.entries.length);
    fallosCount.textContent = String(data.misses.length);
    setTodayStatus();
  }

  function entryCard(e){
    var est = e.estimatedMinutes ? ("â³ "+e.estimatedMinutes+" min") : "";
    var elapsed = (e.elapsedSeconds != null) ? ("â±ï¸ "+fmtTimer(e.elapsedSeconds)) : "";
    var gloss = (Array.isArray(e.glossary) && e.glossary.length)
      ? e.glossary.map(function(g){ return "â€¢ "+g.w+": "+g.d; }).join("\n")
      : "";

    return `
      <div class="rounded-3xl border border-slate-200 bg-white p-4">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-2">
          <div class="min-w-0">
            <div class="text-lg md:text-xl font-black break-words">
              ğŸ•’ ${e.date} â€” ${e.time}
              <span class="ml-2 text-slate-600">${escapeHtml(est)}</span>
              <span class="ml-2 text-slate-600">${escapeHtml(elapsed)}</span>
            </div>
            <div class="mt-1 text-xl md:text-2xl font-extrabold break-words">${escapeHtml(e.title)}</div>
            <div class="mt-1 text-base md:text-lg font-bold text-slate-700 break-words">ğŸ”– ${escapeHtml(e.theme)}</div>
          </div>
          <div class="rounded-2xl bg-emerald-50 border border-emerald-200 px-3 py-2 font-black">
            âœ… Lectura guardada
          </div>
        </div>

        <details class="mt-3">
          <summary class="cursor-pointer font-black text-lg">ğŸ“– Ver lectura</summary>
          <p class="mt-2 text-lg font-semibold text-slate-800 whitespace-pre-wrap break-words">${escapeHtml(e.story)}</p>
        </details>

        ${gloss ? `
        <details class="mt-2">
          <summary class="cursor-pointer font-black text-lg">ğŸ“š Mini glosario</summary>
          <p class="mt-2 text-lg font-semibold text-slate-800 whitespace-pre-wrap break-words">${escapeHtml(gloss)}</p>
        </details>` : ""}

        <details class="mt-2">
          <summary class="cursor-pointer font-black text-lg">ğŸ§  Moraleja de MartÃ­n</summary>
          <p class="mt-2 text-lg font-semibold text-slate-800 whitespace-pre-wrap break-words">${escapeHtml(e.kidMoral)}</p>
        </details>

        <details class="mt-2">
          <summary class="cursor-pointer font-black text-lg">ğŸ“Œ Moraleja real</summary>
          <p class="mt-2 text-lg font-semibold text-slate-800 whitespace-pre-wrap break-words">${escapeHtml(e.realMoral)}</p>
        </details>
      </div>
    `;
  }

  function renderEntries(){
    var items = data.entries.slice().sort(function(a,b){
      return (b.date+" "+b.time).localeCompare(a.date+" "+a.time);
    });
    var html = [];
    if(items.length === 0){
      html.push('<p class="text-lg font-semibold text-slate-700">AÃºn no hay entradas guardadas.</p>');
    }else{
      html.push('<div class="text-xl font-black mt-2">ğŸ“š Lecturas guardadas</div>');
      html.push(items.slice(0,30).map(entryCard).join(""));
    }
    listaEntradas.innerHTML = html.join("");
  }

  function renderEntriesModal(){
    var items = data.entries.slice().sort(function(a,b){
      return (b.date+" "+b.time).localeCompare(a.date+" "+a.time);
    });
    if(items.length === 0){
      listaEntradasModal.innerHTML = '<p class="text-lg font-semibold text-slate-700">AÃºn no hay entradas guardadas.</p>';
      return;
    }
    listaEntradasModal.innerHTML = items.map(entryCard).join("");
  }

  function showStory(st){
    currentStory = st;

    elTituloHistoria.textContent = st.title;
    elTemaHistoria.textContent = st.theme;
    elTextoHistoria.textContent = st.story;

    elTiempoEstimado.textContent = st.estimatedMinutes ? (st.estimatedMinutes+" min") : "â€”";
    elTiempoEstimado2.textContent = st.estimatedMinutes ? (st.estimatedMinutes+" min") : "â€”";

    elapsedSeconds = 0;
    updateElapsedUI();

    if(Array.isArray(st.glossary) && st.glossary.length){
      glosarioLista.innerHTML = st.glossary.map(function(g){
        return `
          <li class="rounded-2xl bg-white border border-slate-200 p-3">
            <span class="font-black">âœ¨ ${escapeHtml(g.w)}</span>
            <span class="text-slate-700 font-semibold"> â€” ${escapeHtml(g.d)}</span>
          </li>
        `;
      }).join("");
      glosarioBox.classList.remove("hidden");
    }else{
      glosarioBox.classList.add("hidden");
      glosarioLista.innerHTML = "";
    }

    inputMoralejaNino.value = "";
    btnMoraleja.classList.add("hidden");
    moralejaBox.classList.add("hidden");
    elMoralejaReal.textContent = "";
    elSaveMsg.textContent = "";
  }

  function saveReadingAndReveal(){
    stopTimer();
    btnPausar.classList.add("hidden");
    btnIniciar.classList.remove("hidden");
    elTimerMsg.textContent = "â¹ï¸ Temporizador detenido. Â¡Entrada guardada!";

    if(!currentStory || !currentStory.realMoral){
      elSaveMsg.textContent = "Primero genera una lectura con ğŸ² Nueva lectura.";
      return;
    }
    var kidMoral = (inputMoralejaNino.value || "").trim();
    if(!kidMoral){
      elSaveMsg.textContent = "Escribe tu moraleja antes de verla âœï¸ğŸ™‚";
      return;
    }

    var d = new Date();
    var entry = {
      id: uid(),
      date: isoDate(d),
      time: pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds()),
      title: currentStory.title,
      theme: currentStory.theme,
      story: currentStory.story,
      kidMoral: kidMoral,
      realMoral: currentStory.realMoral,
      estimatedMinutes: currentStory.estimatedMinutes || null,
      glossary: Array.isArray(currentStory.glossary) ? currentStory.glossary : [],
      elapsedSeconds: elapsedSeconds,
      storyHash: currentStory.storyHash || ""
    };

    data.entries.push(entry);
    saveData(data);

    btnMoraleja.classList.remove("hidden");
    moralejaBox.classList.remove("hidden");
    elMoralejaReal.textContent = currentStory.realMoral;

    elSaveMsg.textContent = "âœ… Guardado en el diario. Â¡Muy bien! ğŸ‰";
    renderCounts();
    renderEntries();
  }

  function revealMoralOnly(){
    if(!currentStory || !currentStory.realMoral) return;
    moralejaBox.classList.remove("hidden");
    elMoralejaReal.textContent = currentStory.realMoral;
  }

  function exportTXT(){
    var lines = [];
    lines.push("ğŸ“š Lectura diaria para MartÃ­n Bautista");
    lines.push("=====================================");
    lines.push("");

    if(data.entries.length){
      lines.push("ğŸ“– Lecturas:");
      data.entries.slice().sort(function(a,b){
        return (b.date+" "+b.time).localeCompare(a.date+" "+a.time);
      }).forEach(function(e){
        lines.push("- "+e.date+" "+e.time+" "+(e.estimatedMinutes ? "(~"+e.estimatedMinutes+" min)" : "")+" "+(e.elapsedSeconds!=null ? "(real "+fmtTimer(e.elapsedSeconds)+")" : ""));
        lines.push("  TÃ­tulo: "+e.title);
        lines.push("  Tema: "+e.theme);
        if(Array.isArray(e.glossary) && e.glossary.length){
          lines.push("  Mini glosario:");
          e.glossary.forEach(function(g){ lines.push("   - "+g.w+": "+g.d); });
        }
        lines.push("  Historia:");
        lines.push(e.story);
        lines.push("  Moraleja de MartÃ­n:");
        lines.push(e.kidMoral);
        lines.push("  Moraleja real:");
        lines.push(e.realMoral);
        lines.push("");
        lines.push("-------------------------------------");
        lines.push("");
      });
    }

    var blob = new Blob([lines.join("\n")], {type:"text/plain;charset=utf-8"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = "diario-lectura-martin.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function borrarTodo(){
    if(!confirm("Â¿Seguro que quieres borrar TODO el diario y el registro de lecturas usadas?")) return;
    SafeStorage.removeItem(LS_KEY);
    data = loadData();
    renderCounts();
    renderEntries();
    resetTimer();
    showStory({
      title:"â€”", theme:"â€”",
      story:"Pulsa â€œğŸ² Nueva lecturaâ€ para comenzar.",
      realMoral:"", estimatedMinutes:null, glossary:[],
      storyHash:"", generatedAt:""
    });
  }

  /* ========= Eventos ========= */
  btnNuevaHistoria.addEventListener("click", function(){
    var r = generateUniqueReading();
    showStory(r);
    resetTimer();
    startTimer();
  });
  btnIniciar.addEventListener("click", startTimer);
  btnPausar.addEventListener("click", function(){
    stopTimer();
    btnPausar.classList.add("hidden");
    btnIniciar.classList.remove("hidden");
    elTimerMsg.textContent = "â¸ï¸ Pausado. Cuando quieras, continÃºa ğŸ™‚";
  });
  btnReiniciar.addEventListener("click", function(){
    resetTimer();
    elTimerMsg.textContent = "ğŸ”„ Reiniciado. Cuando estÃ©s listo, inicia otra vez ğŸ™‚";
  });
  btnGuardarYVer.addEventListener("click", saveReadingAndReveal);
  btnMoraleja.addEventListener("click", revealMoralOnly);
  btnExportar.addEventListener("click", exportTXT);
  btnBorrarTodo.addEventListener("click", borrarTodo);

  btnVerDiario.addEventListener("click", function(){
    renderEntriesModal();
    modalDiario.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  });
  btnCerrarDiario.addEventListener("click", function(){
    modalDiario.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  });
  modalDiario.addEventListener("click", function(e){
    if(e.target === modalDiario){
      modalDiario.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }
  });

  /* ========= Init ========= */
  elFechaHoy.textContent = prettyDateES(new Date());
  elTimerDisplay.textContent = fmtTimer(15*60);
  updateElapsedUI();
  renderCounts();
  renderEntries();

});
</script>
</body>
</html>
